version: '3.8'

services:
  # 主服務：Web介面 + 自動監控
  monitor:
    build: .
    container_name: system_monitor
    volumes:
      - .:/app
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - HOST_PROC=/host/proc
      - HOST_SYS=/host/sys
    ports:
      - "5000:5000"
    privileged: true
    pid: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    # 使用新的啟動腳本，同時運行Web和監控（1秒間隔）
    command: bash -c "python src/system_monitor.py monitor --interval 1 & python -m uvicorn app:app --host 0.0.0.0 --port 5000"
    restart: unless-stopped
    
  # 純監控服務（可選）
  monitor-only:
    build: .
    container_name: system_monitor_only
    volumes:
      - .:/app
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - HOST_PROC=/host/proc
      - HOST_SYS=/host/sys
    privileged: true
    pid: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    command: python src/system_monitor.py monitor --interval 1
    restart: unless-stopped
    profiles:
      - monitoring-only